// components/loraSelector/loraSelector.js

import { Tooltip } from '../ui/tooltip/tooltip.js';

/**
 * LoRA ÏÑ†ÌÉùÍ∏∞ Ïª¥Ìè¨ÎÑåÌä∏ - ÌîåÎ°úÌåÖ Ìå®ÎÑêÏóêÏÑú ÏÇ¨Ïö©
 * LoRA Î™®Îç∏ÏùÑ ÏÑ†ÌÉùÌïòÍ≥† Í∞ÄÏ§ëÏπòÎ•º Ï°∞Ï†àÌïòÎäî Ïù∏ÌÑ∞ÌéòÏù¥Ïä§
 */

export class LoRASelectorComponent {
    constructor() {
        this.containerElement = null;
        this.isInitialized = false;
        this.apiUrl = 'http://localhost:8080/api';
        this.selectedModelType = null; // ÏÑ†ÌÉùÎêú Ï≤¥ÌÅ¨Ìè¨Ïù∏Ìä∏ ÌÉÄÏûÖ (SDXL, WAN Îì±)
        
        // LoRA Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        this.availableLoRAs = []; // ÏÑúÎ≤ÑÏóêÏÑú Î∂àÎü¨Ïò® LoRA Î™©Î°ù
        this.selectedLoRAs = []; // ÏÑ†ÌÉùÎêú LoRA Î™©Î°ù [{ path, name, weight, subfolder }]
        this.loraTree = {}; // Ìè¥Îçî Ìä∏Î¶¨ Íµ¨Ï°∞Î°ú LoRA Ï†ïÎ¶¨
        
        this.eventListeners = []; // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÏ†ÅÏö©
        this.loadingState = { loras: false, error: null }; // Î°úÎî© ÏÉÅÌÉú Í¥ÄÎ¶¨
        
        // UI ÏÉÅÌÉú
        this.searchTerm = '';
        this.showSelectedOnly = false;
        
        // Î∞îÏù∏Îî©Îêú Î©îÏÑúÎìúÎì§
        this.handleModelSelection = this.handleModelSelection.bind(this);
        
        // Ìà¥ÌåÅ Ïª¥Ìè¨ÎÑåÌä∏
        this.tooltip = new Tooltip();
    }
    
    /**
     * renewal ÏïÑÌÇ§ÌÖçÏ≤ò Ìò∏Ìôò init Î©îÏÑúÎìú
     */
    init() {
        if (this.isInitialized || !this.containerElement) {
            return;
        }
        
        this.isInitialized = true;
        
        // DOM ÎßàÏö¥Ìä∏ ÌõÑ Ï¥àÍ∏∞Ìôî
        setTimeout(() => {
            this.setupEventListeners();
            this.loadLoRAModels();
            this.setupModelSelectionListener();
        }, 0);
    }
    
    render() {
        const container = document.createElement('div');
        container.className = 'lora-selector-component';
        container.style.cssText = `
            height: 100%;
            display: flex;
            flex-direction: column;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        `;
        
        // Ìó§Îçî - Í≤ÄÏÉâ Î∞è ÌïÑÌÑ∞
        const header = this.createHeader();
        
        // LoRA Î™©Î°ù Ïª®ÌÖåÏù¥ÎÑà
        const loraList = document.createElement('div');
        loraList.id = 'lora-list-container';
        loraList.className = 'lora-list-container lora-selector-scrollbar';
        loraList.style.cssText = `
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            min-height: 0;
            max-height: 100%;
        `;
        
        // ÏÑ†ÌÉùÎêú LoRA Ïπ¥Ïö¥ÌÑ∞
        const selectedCounter = document.createElement('div');
        selectedCounter.id = 'selected-lora-counter';
        selectedCounter.className = 'selected-counter';
        selectedCounter.style.cssText = `
            padding: 8px 12px;
            background: rgba(155, 89, 182, 0.1);
            border-top: 1px solid rgba(155, 89, 182, 0.2);
            font-size: 12px;
            font-weight: 600;
            color: #7b1fa2;
            text-align: center;
        `;
        selectedCounter.textContent = 'Selected: 0 LoRAs';
        
        // Î°úÎî© ÏÉÅÌÉú ÌëúÏãú
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'lora-loading';
        loadingDiv.style.cssText = `
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
            color: #666;
            font-size: 14px;
        `;
        loadingDiv.innerHTML = `
            <div style="text-align: center;">
                <div style="margin-bottom: 8px;">üîÑ</div>
                <div>Loading LoRA models...</div>
            </div>
        `;
        
        loraList.appendChild(loadingDiv);
        
        // Ïª®ÌÖåÏù¥ÎÑà Ï°∞Î¶Ω
        container.appendChild(header);
        container.appendChild(loraList);
        container.appendChild(selectedCounter);
        
        // CSS Ïä§ÌÉÄÏùº Ï∂îÍ∞Ä
        this.addStyles();
        
        // Ïª®ÌÖåÏù¥ÎÑà Ï∞∏Ï°∞ Ï†ÄÏû•
        this.containerElement = container;
        
        return container;
    }
    
    createHeader() {
        const header = document.createElement('div');
        header.className = 'lora-header';
        header.style.cssText = `
            padding: 12px;
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid rgba(155, 89, 182, 0.2);
            backdrop-filter: blur(10px);
        `;
        
        // Í≤ÄÏÉâ ÏûÖÎ†•
        const searchContainer = document.createElement('div');
        searchContainer.style.cssText = `
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        `;
        
        const searchInput = document.createElement('input');
        searchInput.type = 'text';
        searchInput.id = 'lora-search';
        searchInput.placeholder = 'Search LoRA models...';
        searchInput.style.cssText = `
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        `;
        
        // ÌïÑÌÑ∞ Î≤ÑÌäºÎì§
        const filterContainer = document.createElement('div');
        filterContainer.style.cssText = `
            display: flex;
            gap: 6px;
        `;
        
        const showSelectedBtn = document.createElement('button');
        showSelectedBtn.id = 'show-selected-toggle';
        showSelectedBtn.textContent = 'üìå Selected';
        showSelectedBtn.style.cssText = `
            padding: 6px 10px;
            border: 1px solid #9b59b6;
            background: white;
            color: #9b59b6;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        `;
        
        const clearAllBtn = document.createElement('button');
        clearAllBtn.id = 'clear-all-loras';
        clearAllBtn.textContent = 'üóëÔ∏è Clear';
        clearAllBtn.style.cssText = `
            padding: 6px 10px;
            border: 1px solid #e74c3c;
            background: white;
            color: #e74c3c;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        `;
        
        searchContainer.appendChild(searchInput);
        filterContainer.appendChild(showSelectedBtn);
        filterContainer.appendChild(clearAllBtn);
        
        header.appendChild(searchContainer);
        header.appendChild(filterContainer);
        
        return header;
    }
    
    addStyles() {
        if (document.getElementById('lora-selector-styles')) return;
        
        const style = document.createElement('style');
        style.id = 'lora-selector-styles';
        style.textContent = `
            .lora-selector-component {
                color: #333;
                font-size: 13px;
            }
            
            .lora-item {
                display: flex;
                align-items: center;
                padding: 8px;
                margin: 4px 0;
                background: white;
                border: 1px solid #e0e0e0;
                border-radius: 6px;
                transition: all 0.2s ease;
                cursor: pointer;
            }
            
            .lora-item:hover {
                border-color: #9b59b6;
                box-shadow: 0 2px 8px rgba(155, 89, 182, 0.15);
                transform: translateY(-1px);
            }
            
            .lora-item.selected {
                border-color: #9b59b6;
                background: linear-gradient(135deg, rgba(155, 89, 182, 0.1) 0%, rgba(155, 89, 182, 0.05) 100%);
            }
            
            .lora-item .lora-checkbox {
                width: 16px;
                height: 16px;
                margin-right: 8px;
                accent-color: #9b59b6;
            }
            
            .lora-item .lora-info {
                flex: 1;
                min-width: 0;
            }
            
            .lora-item .lora-name {
                font-weight: 500;
                color: #333;
                margin-bottom: 2px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .lora-item .lora-path {
                font-size: 11px;
                color: #666;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .lora-item .lora-weight {
                display: flex;
                align-items: center;
                gap: 6px;
                margin-left: 8px;
                min-width: 120px;
            }
            
            .lora-item .weight-slider {
                width: 70px;
                height: 4px;
                accent-color: #9b59b6;
            }
            
            .lora-item .weight-value {
                min-width: 35px;
                font-size: 11px;
                font-weight: 600;
                color: #9b59b6;
                background: rgba(155, 89, 182, 0.1);
                padding: 2px 4px;
                border-radius: 3px;
                text-align: center;
            }
            
            .lora-folder {
                margin: 8px 0 4px 0;
                padding: 6px 8px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }
            
            
            .lora-header button:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            }
            
            .lora-header button.active {
                background: #9b59b6;
                color: white;
                border-color: #9b59b6;
            }
            
            #lora-search:focus {
                outline: none;
                border-color: #9b59b6;
                box-shadow: 0 0 0 2px rgba(155, 89, 182, 0.1);
            }
        `;
        
        document.head.appendChild(style);
    }
    
    setupEventListeners() {
        if (!this.containerElement) return;
        
        // Í≤ÄÏÉâ ÏûÖÎ†• Ïù¥Î≤§Ìä∏
        const searchInput = this.containerElement.querySelector('#lora-search');
        if (searchInput) {
            const searchHandler = (e) => {
                this.searchTerm = e.target.value;
                this.filterAndRenderLoRAs();
            };
            searchInput.addEventListener('input', searchHandler);
            this.eventListeners.push({ element: searchInput, event: 'input', handler: searchHandler });
        }
        
        // ÏÑ†ÌÉùÎêú Í≤ÉÎßå Î≥¥Í∏∞ ÌÜ†Í∏Ä
        const showSelectedBtn = this.containerElement.querySelector('#show-selected-toggle');
        if (showSelectedBtn) {
            const toggleHandler = () => {
                this.showSelectedOnly = !this.showSelectedOnly;
                showSelectedBtn.classList.toggle('active', this.showSelectedOnly);
                this.filterAndRenderLoRAs();
            };
            showSelectedBtn.addEventListener('click', toggleHandler);
            this.eventListeners.push({ element: showSelectedBtn, event: 'click', handler: toggleHandler });
        }
        
        // Î™®Îëê ÏßÄÏö∞Í∏∞
        const clearAllBtn = this.containerElement.querySelector('#clear-all-loras');
        if (clearAllBtn) {
            const clearHandler = () => {
                this.selectedLoRAs = [];
                this.updateSelectedCounter();
                this.filterAndRenderLoRAs();
                this.notifyChange();
            };
            clearAllBtn.addEventListener('click', clearHandler);
            this.eventListeners.push({ element: clearAllBtn, event: 'click', handler: clearHandler });
        }
        
        // Ìà¥ÌåÅ Ïù¥Î≤§Ìä∏ ÏÑ§Ï†ï
        this.setupTooltipEvents();
    }
    
    setupTooltipEvents() {
        if (!this.containerElement) return;
        
        // Ìà¥ÌåÅ Ïù¥Î≤§Ìä∏ - ModelExplorerÏôÄ ÎèôÏùºÌïú Ìå®ÌÑ¥
        this.containerElement.addEventListener('mouseover', (e) => {
            if (e.target.closest('.lora-item') && e.target.closest('.lora-item').dataset.previewImage) {
                const loraItem = e.target.closest('.lora-item');
                const loraName = loraItem.querySelector('.lora-name')?.textContent;
                const previewImage = loraItem.dataset.previewImage;
                const subfolder = loraItem.dataset.subfolder;
                
                // Î°úÏª¨ ÌååÏùº ÏãúÏä§ÌÖú Í≤ΩÎ°úÎ°ú Ïù¥ÎØ∏ÏßÄ URL Íµ¨ÏÑ±
                const imageUrl = `models/loras/${subfolder}/${previewImage}`.replace(/\/+/g, '/');
                
                const content = `
                    <div class="tooltip-caption">${loraName}</div>
                    <img src="${imageUrl}" alt="Preview" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div style="display: none; text-align: center; padding: 20px; color: #999;">
                        Ïù¥ÎØ∏ÏßÄÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§
                    </div>
                `;
                
                this.tooltip.show(content, e);
            }
        });
        
        this.containerElement.addEventListener('mouseout', (e) => {
            if (e.target.closest('.lora-item')) {
                this.tooltip.hide();
            }
        });
    }
    
    async loadLoRAModels() {
        this.loadingState.loras = true;
        
        try {
            // Î°úÏª¨ ÌååÏùº ÏãúÏä§ÌÖúÏóêÏÑú LoRA Î™®Îç∏ Ïä§Ï∫î
            const loraModels = await this.scanLocalLoRAModels();
            this.availableLoRAs = loraModels;
            this.buildLoRATree();
            this.loadingState.loras = false;
            this.loadingState.error = null;
            
            // Î°úÎî© ÏôÑÎ£å ÌõÑ Î†åÎçîÎßÅ
            this.filterAndRenderLoRAs();
            
        } catch (error) {
            console.error('LoRA models loading failed:', error);
            this.loadingState.loras = false;
            this.loadingState.error = error.message;
            
            // Í∏∞Î≥∏ Î™©Î°ùÏúºÎ°ú Ìè¥Î∞± (Î°úÏª¨ ÌååÏùº ÏãúÏä§ÌÖú Í∏∞Ï§Ä)
            this.availableLoRAs = await this.getDefaultLoRAList();
            this.buildLoRATree();
            this.filterAndRenderLoRAs();
        }
    }
    
    async scanLocalLoRAModels() {
        // API ÏóÜÏù¥ ÏßÅÏ†ë ÌïòÎìúÏΩîÎî©Îêú Î™©Î°ù ÏÇ¨Ïö©
        // console.log('Loading hardcoded LoRA list (API not available)');
        return this.getHardcodedLoRAList();
    }
    
    getHardcodedLoRAList() {
        // models/loras Ìè¥Îçî Íµ¨Ï°∞Î•º Í∏∞Î∞òÏúºÎ°ú Ìïú ÌïòÎìúÏΩîÎî©Îêú Î™©Î°ù
        return [
            // SDXL/ILXL Ìè¥Îçî
            { name: 'YHILXL-000001', path: 'YHILXL-000001.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'YHILXL-000001.png' },
            { name: 'iLLMythSmo0thL1nes', path: 'iLLMythSmo0thL1nes.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'iLLMythSmo0thL1nes.png' },
            { name: 'ILLMythP0rtr4itStyle', path: 'ILLMythP0rtr4itStyle.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'ILLMythP0rtr4itStyle.jpeg' },
            { name: 'leatherarmor IL', path: 'leatherarmor IL.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'leatherarmor IL.jpeg' },
            { name: 'goblin_IL', path: 'goblin_IL.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'goblin_IL.jpeg' },
            { name: 'minotaur IL', path: 'minotaur IL.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'minotaur IL.jpeg' },
            { name: 'kobold IL', path: 'kobold IL.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'kobold IL.jpeg' },
            { name: 'tieflingIL', path: 'tieflingIL.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'tieflingIL.jpeg' },
            { name: 'yuanti IL', path: 'yuanti IL.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'yuanti IL.jpeg' },
            { name: 'warforged', path: 'warforged.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'warforged.jpeg' },
            { name: 'gnome IL', path: 'gnome IL.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'gnome IL.jpeg' },
            { name: 'viwe_topdown_IL', path: 'viwe_topdown_IL.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'viwe_topdown_IL.jpeg' },
            { name: 'kenku IL', path: 'kenku IL.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'kenku IL.jpeg' },
            { name: 'armors IL', path: 'armors IL.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'armors IL.png' },
            { name: 'NinjaAF_IL', path: 'NinjaAF_IL.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'NinjaAF_IL.png' },
            { name: 'ILXL_YH_Style_DNF', path: 'ILXL_YH_Style_DNF.safetensors', subfolder: 'SDXL/ILXL', preview_image: 'ILXL_YH_Style_DNF.png' },
            
            // SDXL/NOOB Ìè¥Îçî
            { name: 'korean idol-noob-V1', path: 'korean idol-noob-V1.safetensors', subfolder: 'SDXL/NOOB', preview_image: 'korean idol-noob-V1.png' },
            { name: 'Film Photography-NOOB-V1', path: 'Film Photography-NOOB-V1.safetensors', subfolder: 'SDXL/NOOB', preview_image: 'Film Photography-NOOB-V1.png' },
            { name: 'asian beauty face-SDXL-V1', path: 'asian beauty face-SDXL-V1.safetensors', subfolder: 'SDXL/NOOB', preview_image: 'asian beauty face-SDXL-V1.png' },
            
            // WAN Ìè¥Îçî
            { name: 'Wan21_CausVid_14B_T2V_lora_rank32', path: 'Wan21_CausVid_14B_T2V_lora_rank32.safetensors', subfolder: 'WAN' },
            { name: 'Wan21_T2V_14B_lightx2v_cfg_step_distill_lora_rank32', path: 'Wan21_T2V_14B_lightx2v_cfg_step_distill_lora_rank32.safetensors', subfolder: 'WAN' },
            { name: 'Wan2.1-Fun-1.3B-InP-MPS', path: 'Wan2.1-Fun-1.3B-InP-MPS.safetensors', subfolder: 'WAN' },
            { name: 'Wan2.1-Fun-1.3B-InP-HPS2.1', path: 'Wan2.1-Fun-1.3B-InP-HPS2.1.safetensors', subfolder: 'WAN' },
            { name: 'Wan2.1-Fun-14B-InP-MPS', path: 'Wan2.1-Fun-14B-InP-MPS.safetensors', subfolder: 'WAN' },
            { name: 'Wan2.1-Fun-14B-InP-HPS2.1', path: 'Wan2.1-Fun-14B-InP-HPS2.1.safetensors', subfolder: 'WAN' },
            { name: 'Wan2.1_T2V_14B_FusionX_LoRA', path: 'Wan2.1_T2V_14B_FusionX_LoRA.safetensors', subfolder: 'WAN' },
            { name: 'Wan2.1_I2V_14B_FusionX_LoRA', path: 'Wan2.1_I2V_14B_FusionX_LoRA.safetensors', subfolder: 'WAN' },
            
            // WAN/KJ_WAN ÌïòÏúÑÌè¥Îçî
            { name: 'Wan2.1-Fun-1.3B-InP-MPS_reward_lora_comfy', path: 'Wan2.1-Fun-1.3B-InP-MPS_reward_lora_comfy.safetensors', subfolder: 'WAN/KJ_WAN' },
            { name: 'Wan2.1-Fun-14B-InP-MPS_reward_lora_comfy', path: 'Wan2.1-Fun-14B-InP-MPS_reward_lora_comfy.safetensors', subfolder: 'WAN/KJ_WAN' },
            { name: 'Wan21_T2V_14B_MoviiGen_lora_rank32_fp16', path: 'Wan21_T2V_14B_MoviiGen_lora_rank32_fp16.safetensors', subfolder: 'WAN/KJ_WAN' },
            { name: 'lightx2v_T2V_14B_cfg_step_distill_v2_lora_rank32_bf16', path: 'lightx2v_T2V_14B_cfg_step_distill_v2_lora_rank32_bf16.safetensors', subfolder: 'WAN/KJ_WAN' },
            { name: 'lightx2v_T2V_14B_cfg_step_distill_v2_lora_rank64_bf16', path: 'lightx2v_T2V_14B_cfg_step_distill_v2_lora_rank64_bf16.safetensors', subfolder: 'WAN/KJ_WAN' },
            { name: 'wan_i2v_720_l1v3w4llp4p3r_e50_with_trigger', path: 'wan_i2v_720_l1v3w4llp4p3r_e50_with_trigger.safetensors', subfolder: 'WAN/KJ_WAN' }
        ];
    }
    
    async getDefaultLoRAList() {
        return [
            { name: 'Default LoRA 1', path: 'default_lora_1.safetensors', subfolder: 'default' },
            { name: 'Default LoRA 2', path: 'default_lora_2.safetensors', subfolder: 'default' }
        ];
    }
    
    buildLoRATree() {
        this.loraTree = {};
        
        // ÏÑ†ÌÉùÎêú Î™®Îç∏ ÌÉÄÏûÖÏóê Îî∞Îùº ÌïÑÌÑ∞ÎßÅ
        let filteredLoRAs = this.availableLoRAs;
        if (this.selectedModelType) {
            filteredLoRAs = this.availableLoRAs.filter(lora => {
                return lora.subfolder && lora.subfolder.toLowerCase().startsWith(this.selectedModelType.toLowerCase());
            });
        }
        
        filteredLoRAs.forEach(lora => {
            const folder = lora.subfolder || 'root';
            if (!this.loraTree[folder]) {
                this.loraTree[folder] = [];
            }
            this.loraTree[folder].push(lora);
        });
        
        // Ìè¥ÎçîÎ≥Ñ Ï†ïÎ†¨
        Object.keys(this.loraTree).forEach(folder => {
            this.loraTree[folder].sort((a, b) => a.name.localeCompare(b.name));
        });
    }
    
    setupModelSelectionListener() {
        // Î™®Îç∏ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
        document.addEventListener('model:selected', this.handleModelSelection);
    }
    
    handleModelSelection(e) {
        const modelInfo = e.detail;
        console.log('LoRA Selector: Model selection changed', modelInfo);
        
        // ÏÑ†ÌÉùÎêú Î™®Îç∏Ïùò Ï≤´ Î≤àÏß∏ Ìè¥ÎçîÎ™ÖÏùÑ Ï∂îÏ∂úÌïòÏó¨ Î™®Îç∏ ÌÉÄÏûÖ Í≤∞Ï†ï
        if (modelInfo && modelInfo.subfolder) {
            const subfolderParts = modelInfo.subfolder.split(/[\/\\]/).filter(p => p);
            this.selectedModelType = subfolderParts.length > 0 ? subfolderParts[0] : null;
            
            console.log('LoRA Selector: Model type set to', this.selectedModelType);
            
            // LoRA Ìä∏Î¶¨ Ïû¨Íµ¨ÏÑ± Î∞è Î†åÎçîÎßÅ
            this.buildLoRATree();
            this.filterAndRenderLoRAs();
            
            // Ìå®ÎÑê Ï†úÎ™©Ïóê Î™®Îç∏ ÌÉÄÏûÖ ÌëúÏãú
            this.updatePanelTitle();
        }
    }
    
    updatePanelTitle() {
        // ÌîåÎ°úÌåÖ Ìå®ÎÑê Ï†úÎ™© ÏóÖÎç∞Ïù¥Ìä∏
        const panelElement = this.containerElement?.closest('.floating-panel');
        if (panelElement) {
            const titleElement = panelElement.querySelector('.floating-panel-title');
            if (titleElement) {
                const baseTitle = 'üé® LoRA Selector';
                const newTitle = this.selectedModelType 
                    ? `${baseTitle} (${this.selectedModelType})`
                    : baseTitle;
                titleElement.textContent = newTitle;
            }
        }
    }
    
    filterAndRenderLoRAs() {
        const container = this.containerElement?.querySelector('#lora-list-container');
        if (!container) return;
        
        // Î°úÎî© Ï§ëÏù¥Î©¥ Î°úÎî© ÌëúÏãú
        if (this.loadingState.loras) {
            return;
        }
        
        container.innerHTML = '';
        
        // ÏóêÎü¨ ÏÉÅÌÉú ÌëúÏãú
        if (this.loadingState.error) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                padding: 20px;
                text-align: center;
                color: #e74c3c;
                font-size: 14px;
            `;
            errorDiv.innerHTML = `
                <div style="margin-bottom: 8px;">‚ö†Ô∏è</div>
                <div>Error loading LoRAs: ${this.loadingState.error}</div>
                <div style="margin-top: 8px; font-size: 12px; color: #666;">Using default list</div>
            `;
            container.appendChild(errorDiv);
        }
        
        const folders = Object.keys(this.loraTree).sort();
        
        folders.forEach(folderName => {
            const loras = this.loraTree[folderName];
            let filteredLoRAs = loras;
            
            // Í≤ÄÏÉâ ÌïÑÌÑ∞ Ï†ÅÏö©
            if (this.searchTerm) {
                filteredLoRAs = loras.filter(lora => 
                    lora.name.toLowerCase().includes(this.searchTerm.toLowerCase())
                );
            }
            
            // ÏÑ†ÌÉùÎêú Í≤ÉÎßå Î≥¥Í∏∞ ÌïÑÌÑ∞
            if (this.showSelectedOnly) {
                filteredLoRAs = filteredLoRAs.filter(lora =>
                    this.selectedLoRAs.some(selected => selected.path === lora.path)
                );
            }
            
            // ÌïÑÌÑ∞ÎßÅ Í≤∞Í≥ºÍ∞Ä ÏûàÏùÑ ÎïåÎßå Ìè¥Îçî ÌëúÏãú
            if (filteredLoRAs.length > 0) {
                // Ìè¥Îçî Ìó§Îçî
                const folderDiv = document.createElement('div');
                folderDiv.className = 'lora-folder';
                folderDiv.textContent = `üìÅ ${folderName} (${filteredLoRAs.length})`;
                container.appendChild(folderDiv);
                
                // LoRA ÏïÑÏù¥ÌÖúÎì§
                filteredLoRAs.forEach(lora => {
                    const loraItem = this.createLoRAItem(lora);
                    container.appendChild(loraItem);
                });
            }
        });
        
        // Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå
        if (container.children.length === 0) {
            const noResultDiv = document.createElement('div');
            noResultDiv.style.cssText = `
                padding: 40px 20px;
                text-align: center;
                color: #666;
                font-size: 14px;
            `;
            noResultDiv.innerHTML = `
                <div style="margin-bottom: 8px;">üîç</div>
                <div>No LoRAs found</div>
                ${this.searchTerm ? '<div style="font-size: 12px; margin-top: 4px;">Try different search terms</div>' : ''}
            `;
            container.appendChild(noResultDiv);
        }
    }
    
    createLoRAItem(lora) {
        const item = document.createElement('div');
        item.className = 'lora-item';
        item.dataset.subfolder = lora.subfolder || '';
        
        // ÎØ∏Î¶¨Î≥¥Í∏∞ Ïù¥ÎØ∏ÏßÄ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
        if (lora.preview_image) {
            item.dataset.previewImage = lora.preview_image;
        }
        
        const isSelected = this.selectedLoRAs.some(selected => selected.path === lora.path);
        if (isSelected) {
            item.classList.add('selected');
        }
        
        // Ï≤¥ÌÅ¨Î∞ïÏä§
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'lora-checkbox';
        checkbox.checked = isSelected;
        
        // LoRA Ï†ïÎ≥¥
        const info = document.createElement('div');
        info.className = 'lora-info';
        info.innerHTML = `
            <div class="lora-name">${lora.name}</div>
            <div class="lora-path">${lora.path}</div>
        `;
        
        // Í∞ÄÏ§ëÏπò Ïª®Ìä∏Î°§ (ÏÑ†ÌÉùÎêú Í≤ΩÏö∞Îßå)
        const weightControl = document.createElement('div');
        weightControl.className = 'lora-weight';
        
        if (isSelected) {
            const selectedLora = this.selectedLoRAs.find(selected => selected.path === lora.path);
            const weight = selectedLora ? selectedLora.weight : 1.0;
            
            const slider = document.createElement('input');
            slider.type = 'range';
            slider.className = 'weight-slider';
            slider.min = '0';
            slider.max = '2';
            slider.step = '0.1';
            slider.value = weight;
            
            const valueDisplay = document.createElement('span');
            valueDisplay.className = 'weight-value';
            valueDisplay.textContent = weight.toFixed(1);
            
            // Ïä¨ÎùºÏù¥Îçî Ïù¥Î≤§Ìä∏
            slider.addEventListener('input', (e) => {
                const newWeight = parseFloat(e.target.value);
                valueDisplay.textContent = newWeight.toFixed(1);
                this.updateLoRAWeight(lora.path, newWeight);
            });
            
            weightControl.appendChild(slider);
            weightControl.appendChild(valueDisplay);
        }
        
        // Ï≤¥ÌÅ¨Î∞ïÏä§ Ïù¥Î≤§Ìä∏
        checkbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                this.selectLoRA(lora);
            } else {
                this.deselectLoRA(lora.path);
            }
            
            // UI Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏Î•º ÏúÑÌï¥ Îã§Ïãú Î†åÎçîÎßÅ
            setTimeout(() => this.filterAndRenderLoRAs(), 0);
        });
        
        // ÎØ∏Î¶¨Î≥¥Í∏∞ Ìà¥ÌåÅÏùÄ setupTooltipEventsÏóêÏÑú Ï≤òÎ¶¨Îê®
        
        item.appendChild(checkbox);
        item.appendChild(info);
        item.appendChild(weightControl);
        
        return item;
    }
    
    selectLoRA(lora) {
        // Ïù¥ÎØ∏ ÏÑ†ÌÉùÎêòÏñ¥ ÏûàÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ÏóêÎßå Ï∂îÍ∞Ä
        if (!this.selectedLoRAs.some(selected => selected.path === lora.path)) {
            this.selectedLoRAs.push({
                path: lora.path,
                name: lora.name,
                weight: 1.0,
                subfolder: lora.subfolder
            });
            
            this.updateSelectedCounter();
            this.notifyChange();
        }
    }
    
    deselectLoRA(loraPath) {
        this.selectedLoRAs = this.selectedLoRAs.filter(selected => selected.path !== loraPath);
        this.updateSelectedCounter();
        this.notifyChange();
    }
    
    updateLoRAWeight(loraPath, weight) {
        const selectedLora = this.selectedLoRAs.find(selected => selected.path === loraPath);
        if (selectedLora) {
            selectedLora.weight = weight;
            this.notifyChange();
        }
    }
    
    updateSelectedCounter() {
        const counter = this.containerElement?.querySelector('#selected-lora-counter');
        if (counter) {
            counter.textContent = `Selected: ${this.selectedLoRAs.length} LoRAs`;
        }
    }
    
    
    notifyChange() {
        // Ïª§Ïä§ÌÖÄ Ïù¥Î≤§Ìä∏Î°ú Î≥ÄÍ≤Ω ÏïåÎ¶º
        document.dispatchEvent(new CustomEvent('loraSelector:changed', {
            detail: {
                selectedLoRAs: [...this.selectedLoRAs],
                totalSelected: this.selectedLoRAs.length
            }
        }));
        
        console.log('LoRA selection changed:', this.selectedLoRAs);
    }
    
    // Ï†ïÎ¶¨ Î©îÏÑúÎìú
    cleanupEventListeners() {
        this.eventListeners.forEach(({ element, event, handler }) => {
            element.removeEventListener(event, handler);
        });
        this.eventListeners = [];
    }
    
    destroy() {
        this.cleanupEventListeners();
        
        // Î™®Îç∏ ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï†úÍ±∞
        document.removeEventListener('model:selected', this.handleModelSelection);
        
        // Ìà¥ÌåÅ Ï†úÍ±∞ (Tooltip Ïª¥Ìè¨ÎÑåÌä∏ ÏÇ¨Ïö©)
        if (this.tooltip) {
            this.tooltip.hide();
        }
        
        console.log('LoRA Selector component destroyed');
    }
    
    /**
     * ÏÉÅÌÉú Î≥¥Ï°¥ÏùÑ ÏúÑÌïú refreshData Î©îÏÑúÎìú
     * FloatingPanel Î≥µÏõê Ïãú Ìò∏Ï∂úÎêòÏñ¥ ÏÉÅÌÉúÎ•º Î≥¥Ï°¥ÌïòÎ©¥ÏÑú Îç∞Ïù¥ÌÑ∞ Ïû¨Î°úÎìú
     */
    refreshData() {
        if (!this.containerElement) return;
        
        console.log('LoRA Selector: Refreshing data after DOM restore');
        
        // ÌòÑÏû¨ ÏÉÅÌÉú Î∞±ÏóÖ
        const previousSearchTerm = this.searchTerm;
        const previousSelectedLoRAs = [...this.selectedLoRAs];
        const previousShowSelectedOnly = this.showSelectedOnly;
        const previousSelectedModelType = this.selectedModelType;
        
        console.log('Preserving LoRA Selector state:', {
            searchTerm: previousSearchTerm,
            selectedLoRAs: previousSelectedLoRAs.length,
            showSelectedOnly: previousShowSelectedOnly,
            selectedModelType: previousSelectedModelType
        });
        
        // DOM Ïû¨ÏÉùÏÑ±ÏùÄ ÌïòÏßÄ ÏïäÍ≥† Îç∞Ïù¥ÌÑ∞Îßå Ïû¨Î°úÎìú
        this.loadLoRAModels().then(() => {
            this.restoreLoRAState(
                previousSearchTerm, 
                previousSelectedLoRAs, 
                previousShowSelectedOnly, 
                previousSelectedModelType
            );
        }).catch(() => {
            // ÏóêÎü¨Í∞Ä Î∞úÏÉùÌï¥ÎèÑ ÏÉÅÌÉúÎäî Î≥µÏõê
            this.restoreLoRAState(
                previousSearchTerm, 
                previousSelectedLoRAs, 
                previousShowSelectedOnly, 
                previousSelectedModelType
            );
        });
    }
    
    /**
     * LoRA ÏÑ†ÌÉùÍ∏∞ ÏÉÅÌÉú Î≥µÏõê
     */
    restoreLoRAState(previousSearchTerm, previousSelectedLoRAs, previousShowSelectedOnly, previousSelectedModelType) {
        console.log('Restoring LoRA Selector state...');
        
        // Í∏∞Î≥∏ ÏÉÅÌÉú Î≥µÏõê
        this.searchTerm = previousSearchTerm;
        this.selectedLoRAs = previousSelectedLoRAs;
        this.showSelectedOnly = previousShowSelectedOnly;
        this.selectedModelType = previousSelectedModelType;
        
        // UI ÏöîÏÜåÎì§ ÏÉÅÌÉú Î≥µÏõê
        this.restoreUIElements();
        
        // LoRA Ìä∏Î¶¨ Ïû¨Íµ¨ÏÑ± (Î™®Îç∏ ÌÉÄÏûÖÏóê ÎßûÍ≤å)
        this.buildLoRATree();
        
        // ÌïÑÌÑ∞ÎßÅ Î∞è Î†åÎçîÎßÅ
        this.filterAndRenderLoRAs();
        
        // Ïπ¥Ïö¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        this.updateSelectedCounter();
        
        console.log('LoRA Selector state restored successfully');
    }
    
    /**
     * UI ÏöîÏÜåÎì§Ïùò ÏÉÅÌÉú Î≥µÏõê
     */
    restoreUIElements() {
        if (!this.containerElement) return;
        
        // Í≤ÄÏÉâ ÏûÖÎ†• ÌïÑÎìú Î≥µÏõê
        const searchInput = this.containerElement.querySelector('#lora-search');
        if (searchInput) {
            searchInput.value = this.searchTerm;
        }
        
        // Selected ÌïÑÌÑ∞ Î≤ÑÌäº ÏÉÅÌÉú Î≥µÏõê
        const showSelectedBtn = this.containerElement.querySelector('#show-selected-toggle');
        if (showSelectedBtn) {
            showSelectedBtn.classList.toggle('active', this.showSelectedOnly);
            if (this.showSelectedOnly) {
                showSelectedBtn.style.background = '#9b59b6';
                showSelectedBtn.style.color = 'white';
                showSelectedBtn.style.borderColor = '#9b59b6';
            } else {
                showSelectedBtn.style.background = 'white';
                showSelectedBtn.style.color = '#9b59b6';
                showSelectedBtn.style.borderColor = '#9b59b6';
            }
        }
        
        // Ìå®ÎÑê Ï†úÎ™© Î≥µÏõê
        this.updatePanelTitle();
        
        console.log('UI elements restored:', {
            searchTerm: this.searchTerm,
            showSelectedOnly: this.showSelectedOnly,
            selectedModelType: this.selectedModelType
        });
    }
    
    /**
     * Í∞úÏÑ†Îêú LoRA Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î©îÏÑúÎìú (ÏÉÅÌÉú Î≥¥Ï°¥Ïö©)
     */
    async loadAvailableLoRAs() {
        // Í∏∞Ï°¥ loadLoRAModelsÏôÄ ÎèôÏùºÌïòÏßÄÎßå ÏÉÅÌÉú Î≥¥Ï°¥Ïóê ÏµúÏ†ÅÌôî
        this.loadingState.loras = true;
        
        try {
            const loraModels = await this.scanLocalLoRAModels();
            this.availableLoRAs = loraModels;
            this.loadingState.loras = false;
            this.loadingState.error = null;
            
            console.log('LoRA models reloaded:', this.availableLoRAs.length);
            return Promise.resolve();
            
        } catch (error) {
            console.error('LoRA models loading failed:', error);
            this.loadingState.loras = false;
            this.loadingState.error = error.message;
            
            // Í∏∞Î≥∏ Î™©Î°ùÏúºÎ°ú Ìè¥Î∞±
            this.availableLoRAs = await this.getDefaultLoRAList();
            return Promise.resolve();
        }
    }

    // API Î©îÏÑúÎìúÎì§
    getSelectedLoRAs() {
        return [...this.selectedLoRAs];
    }
    
    setSelectedLoRAs(loras) {
        this.selectedLoRAs = loras.map(lora => ({ ...lora }));
        this.updateSelectedCounter();
        this.filterAndRenderLoRAs();
        this.notifyChange();
    }
    
    clearSelection() {
        this.selectedLoRAs = [];
        this.updateSelectedCounter();
        this.filterAndRenderLoRAs();
        this.notifyChange();
    }
}