<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ControlNet System Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #e8eaed;
        }
        
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .test-section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #444;
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .pass { background: rgba(39, 174, 96, 0.2); border-left: 4px solid #27ae60; }
        .fail { background: rgba(231, 76, 60, 0.2); border-left: 4px solid #e74c3c; }
        .warning { background: rgba(243, 156, 18, 0.2); border-left: 4px solid #f39c12; }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        .json-display {
            background: #1a1a1a;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🎨 ControlNet System Test</h1>
        
        <div class="test-section">
            <h2>📊 Backend API Tests</h2>
            <button onclick="testBackendAPIs()">Test Backend APIs</button>
            <div id="backend-results"></div>
        </div>

        <div class="test-section">
            <h2>🎛️ ControlNet Manager Tests</h2>
            <button onclick="testControlNetManager()">Test ControlNet Manager</button>
            <div id="controlnet-results"></div>
        </div>

        <div class="test-section">
            <h2>📋 5-Tab System Tests</h2>
            <button onclick="testTabSystem()">Test 5-Tab System</button>
            <div id="tabs-results"></div>
        </div>

        <div class="test-section">
            <h2>🔄 Processor Tests</h2>
            <button onclick="testProcessors()">Test Processors</button>
            <div id="processor-results"></div>
        </div>

        <div class="test-section">
            <h2>🚀 Run All Tests</h2>
            <button onclick="runAllControlNetTests()">Run Complete ControlNet Test Suite</button>
            <button onclick="clearResults()">Clear Results</button>
            <div id="summary"></div>
        </div>
    </div>

    <script type="module">
        let testResults = [];

        function addResult(section, test, status, message, data = null) {
            const element = document.getElementById(section);
            const result = document.createElement('div');
            result.className = `test-result ${status}`;
            
            let content = `<strong>${test}:</strong> ${message}`;
            if (data) {
                content += `<div class="json-display">${JSON.stringify(data, null, 2)}</div>`;
            }
            result.innerHTML = content;
            element.appendChild(result);
            
            testResults.push({ section, test, status, message, data });
        }

        window.addResult = addResult;

        window.testBackendAPIs = async function() {
            const section = 'backend-results';
            document.getElementById(section).innerHTML = '';
            
            // Test processors categories
            try {
                const response = await fetch('http://localhost:9004/api/processors/categories');
                const data = await response.json();
                
                if (response.ok && data.edge_detection && data.depth_normal) {
                    addResult(section, 'Processors Categories', 'pass', 
                        `✅ Found ${Object.keys(data).length} categories`, data);
                } else {
                    addResult(section, 'Processors Categories', 'fail', '❌ Invalid categories response');
                }
            } catch (error) {
                addResult(section, 'Processors Categories', 'fail', `❌ Error: ${error.message}`);
            }

            // Test processors stats
            try {
                const response = await fetch('http://localhost:9004/api/processors/stats');
                const data = await response.json();
                
                if (response.ok && data.total_models && data.available_models) {
                    addResult(section, 'Processors Stats', 'pass', 
                        `✅ ${data.available_models}/${data.total_models} models available`);
                } else {
                    addResult(section, 'Processors Stats', 'fail', '❌ Invalid stats response');
                }
            } catch (error) {
                addResult(section, 'Processors Stats', 'fail', `❌ Error: ${error.message}`);
            }

            // Test legacy preprocessors endpoint
            try {
                const response = await fetch('http://localhost:9004/api/preprocessors');
                const data = await response.json();
                
                if (response.ok && Array.isArray(data) && data.length > 0) {
                    const availableCount = data.filter(p => p.available).length;
                    addResult(section, 'Legacy Preprocessors', 'pass', 
                        `✅ ${availableCount}/${data.length} preprocessors available`);
                } else {
                    addResult(section, 'Legacy Preprocessors', 'fail', '❌ Invalid preprocessors response');
                }
            } catch (error) {
                addResult(section, 'Legacy Preprocessors', 'fail', `❌ Error: ${error.message}`);
            }
        };

        window.testControlNetManager = async function() {
            const section = 'controlnet-results';
            document.getElementById(section).innerHTML = '';
            
            try {
                // Try to import the ControlNet manager
                const { openControlNetPanel } = await import('./components/controlnet/controlNetManager.js');
                
                if (typeof openControlNetPanel === 'function') {
                    addResult(section, 'ControlNet Manager Import', 'pass', 
                        '✅ Successfully imported ControlNet manager');
                } else {
                    addResult(section, 'ControlNet Manager Import', 'fail', 
                        '❌ openControlNetPanel is not a function');
                }
            } catch (error) {
                addResult(section, 'ControlNet Manager Import', 'fail', 
                    `❌ Import error: ${error.message}`);
            }

            // Test if Konva is available (required for ControlNet)
            if (window.Konva) {
                addResult(section, 'Konva Library', 'pass', 
                    `✅ Konva ${window.Konva.version} available`);
            } else {
                addResult(section, 'Konva Library', 'fail', 
                    '❌ Konva library not found');
            }
        };

        window.testTabSystem = async function() {
            const section = 'tabs-results';
            document.getElementById(section).innerHTML = '';
            
            try {
                // Import ControlNet manager to test tab system
                const { openControlNetPanel } = await import('./components/controlnet/controlNetManager.js');
                
                if (!window.Konva) {
                    addResult(section, 'Tab System Prerequisites', 'fail', 
                        '❌ Konva not available - cannot test tab system');
                    return;
                }

                // Create a mock image for testing
                const stage = new Konva.Stage({
                    container: document.body,
                    width: 100,
                    height: 100,
                    visible: false
                });

                const layer = new Konva.Layer();
                const imageObj = new Image();
                imageObj.onload = function() {
                    const image = new Konva.Image({
                        x: 0,
                        y: 0,
                        image: imageObj,
                        width: 50,
                        height: 50
                    });

                    layer.add(image);
                    stage.add(layer);

                    // Test opening ControlNet panel
                    try {
                        const modal = openControlNetPanel(image);
                        if (modal && modal.element) {
                            addResult(section, 'ControlNet Modal Creation', 'pass', 
                                '✅ Successfully created ControlNet modal');

                            // Test if modal contains tabs
                            const tabs = modal.element.querySelectorAll('.controlnet-tab');
                            if (tabs.length >= 5) {
                                addResult(section, '5-Tab System', 'pass', 
                                    `✅ Found ${tabs.length} tabs in ControlNet modal`);

                                // Test tab names
                                const tabNames = Array.from(tabs).map(tab => 
                                    tab.textContent.trim());
                                addResult(section, 'Tab Names', 'pass', 
                                    '✅ Tab names: ' + tabNames.join(', '));
                            } else {
                                addResult(section, '5-Tab System', 'fail', 
                                    `❌ Expected 5 tabs, found ${tabs.length}`);
                            }

                            // Test tab switching
                            if (tabs.length > 1) {
                                tabs[1].click();
                                addResult(section, 'Tab Switching', 'pass', 
                                    '✅ Tab switching works');
                            }

                            // Cleanup
                            modal.close();
                        } else {
                            addResult(section, 'ControlNet Modal Creation', 'fail', 
                                '❌ Failed to create ControlNet modal');
                        }
                    } catch (error) {
                        addResult(section, 'ControlNet Modal Creation', 'fail', 
                            `❌ Error creating modal: ${error.message}`);
                    }

                    // Cleanup
                    stage.destroy();
                };

                // Use a small test image
                imageObj.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==';
                
            } catch (error) {
                addResult(section, 'Tab System Test', 'fail', 
                    `❌ Error: ${error.message}`);
            }
        };

        window.testProcessors = async function() {
            const section = 'processor-results';
            document.getElementById(section).innerHTML = '';
            
            try {
                // Test Canny processor import
                const { processCannyEdge } = await import('./components/controlnet/processors/cannyProcessor.js');
                if (typeof processCannyEdge === 'function') {
                    addResult(section, 'Canny Processor Import', 'pass', 
                        '✅ Successfully imported Canny processor');
                } else {
                    addResult(section, 'Canny Processor Import', 'fail', 
                        '❌ processCannyEdge is not a function');
                }
            } catch (error) {
                addResult(section, 'Canny Processor Import', 'fail', 
                    `❌ Import error: ${error.message}`);
            }

            try {
                // Test Depth processor import
                const { processDepthMap } = await import('./components/controlnet/processors/depthProcessor.js');
                if (typeof processDepthMap === 'function') {
                    addResult(section, 'Depth Processor Import', 'pass', 
                        '✅ Successfully imported Depth processor');
                } else {
                    addResult(section, 'Depth Processor Import', 'fail', 
                        '❌ processDepthMap is not a function');
                }
            } catch (error) {
                addResult(section, 'Depth Processor Import', 'fail', 
                    `❌ Import error: ${error.message}`);
            }

            // Test processor functionality with a simple image
            try {
                const { processCannyEdge } = await import('./components/controlnet/processors/cannyProcessor.js');
                
                const testImage = new Image();
                testImage.onload = function() {
                    try {
                        const result = processCannyEdge(testImage, { 
                            lowThreshold: 50, 
                            highThreshold: 150 
                        });
                        
                        if (result && result instanceof HTMLCanvasElement) {
                            addResult(section, 'Canny Processing', 'pass', 
                                `✅ Canny processing works (${result.width}x${result.height})`);
                        } else {
                            addResult(section, 'Canny Processing', 'fail', 
                                '❌ Canny processing failed or returned invalid result');
                        }
                    } catch (error) {
                        addResult(section, 'Canny Processing', 'fail', 
                            `❌ Processing error: ${error.message}`);
                    }
                };
                
                testImage.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==';
                
            } catch (error) {
                addResult(section, 'Processor Functionality', 'fail', 
                    `❌ Error: ${error.message}`);
            }
        };

        window.runAllControlNetTests = async function() {
            clearResults();
            
            console.log('🚀 Starting ControlNet test suite...');
            
            await testBackendAPIs();
            await testControlNetManager();
            await testTabSystem();
            await testProcessors();
            
            // Generate summary
            const summary = document.getElementById('summary');
            const totalTests = testResults.length;
            const passedTests = testResults.filter(r => r.status === 'pass').length;
            const failedTests = testResults.filter(r => r.status === 'fail').length;
            const warningTests = testResults.filter(r => r.status === 'warning').length;
            
            const passRate = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;
            
            summary.innerHTML = `
                <div class="test-result ${failedTests > 0 ? 'fail' : passedTests === totalTests ? 'pass' : 'warning'}">
                    <h3>📊 ControlNet Test Summary</h3>
                    <p><strong>Pass Rate:</strong> ${passRate}% (${passedTests}/${totalTests})</p>
                    <p><strong>✅ Passed:</strong> ${passedTests}</p>
                    <p><strong>❌ Failed:</strong> ${failedTests}</p>
                    <p><strong>⚠️ Warnings:</strong> ${warningTests}</p>
                    <p><strong>Timestamp:</strong> ${new Date().toLocaleString()}</p>
                </div>
            `;
            
            console.log(`✅ ControlNet tests completed! Pass rate: ${passRate}%`);
        };

        window.clearResults = function() {
            const sections = ['backend-results', 'controlnet-results', 'tabs-results', 'processor-results', 'summary'];
            sections.forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
            testResults = [];
        };

        // Load Konva for testing
        const script = document.createElement('script');
        script.src = './assets/js/libs/konva.min.js';
        script.onload = function() {
            console.log('✅ Konva loaded for testing');
        };
        document.head.appendChild(script);

    </script>
</body>
</html>